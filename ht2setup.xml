<?xml version="1.0"?>
<!--

  HappyTrails 2.0 Common Build File

  Last updated:  $DateTime: 2007/07/24 20:23:10 $


  ACKNOWLEDGEMENTS:

  This is adapted from Eric Crahen's TrailRunner examples. Thanks, Eric!


  INSTALLATION:

  Copy this file into your package. Import it from your build.xml file. Enjoy!  :)


  CHANGE NOTICE:

  This file will change many times in the future.  It will never change in
  _your_ package until you want it to!  Please keep an eye on the HappyTrails
  home page so that you can pick up the latest and greatest changes!


  USAGE:

  The main feature here is that by restructuring the build file, we invert control
  of the build, so that users build.xml is in control, and only includes the HappyTrails
  Common Build File for support.
 
  This allows user defined targets to be selected from the command line
  without having to add a subant rule for each target they would like to
  run explicitly. e.g. The following commands are now possible

  ant javadoc
  ant checkstyle
  ant emmma 

  <project name="minimal" default="yourTarget">
  
    <import file="commonTrails.xml" optional="false" />

    <target name="yourTarget" depends="commonTrails" />

  </project>


  In this example, your build target "yourTarget" depends on
  the "commonTrails" initialization target. After that runs,
  everything is all set - packages are cached, and classpaths
  are set up too!
  

  DON'T FORGET!

  export WORKSPACE_ROOT=/workspace/path/to/yourP4client
  export HT2_BOOTSTRAP_JAR=`/opt/amazon/platform-services/etc/BrazilTools-2.1/src/scripts/bootstrap-cache-package-version $WORKSPACE_ROOT MiniTrails 2.0`/lib/miniTrails-2.0.jar


  FOR MORE INFORMATION:

  HappyTrails 2.0 Common Build File Documentation:

  https://spectre.amazon.com/?HappyTrails2/CommonBuildFile

  Ant Home Page:          http://ant.apache.org/manual/
  HappyTrails Home Page:  https://spectre.amazon.com/?HappyTrails2
  HappyTrails FAQ:        https://spectre.amazon.com/?HappyTrails2/FAQ


  Thanks again for using HappyTrails 2.0!

  Sincerely,

    SPECTRE Team and the Amazon.com HappyTrails Developer Community

-->
<project
  xmlns:ht2b="antlib:amazon.ht2.mini.trails.ant"
  xmlns:ht2="antlib:amazon.ht2.trails.ant">


  <property environment="env" />
  <available property="htbootstrap.exists" file="${env.HT2_BOOTSTRAP_JAR}" />
  <fail unless="htbootstrap.exists"  message="HT2_BOOTSTRAP_JAR environment variable not defined or jar does not exist! (Check '${env.HT2_BOOTSTRAP_JAR}')" />


  <!-- MiniTrails 2.0 Bootstrap Task Definition (tasks with ht2b: prefix) -->
  <taskdef resource="amazon/ht2/mini/trails/ant/antlib.xml" onerror="fail"
    uri="antlib:amazon.ht2.mini.trails.ant" classpath="${env.HT2_BOOTSTRAP_JAR}" />


  <!-- Default Bootstrapping Mode: Minimalism (no Codigo support) -->
  <ht2b:bootpath packages="HappyTrails-2.0" /> 

  <!--
    Use this line instead if you would like the Codigo plugin and legacy target type support.
    (make sure that your Config file has the proper build deps for each plugin)

  <ht2b:bootpath packages="HappyTrails-2.0, HappyTrailsCodigoPlugin-2.0, HappyTrailsLegacyBrazilPlugin-2.0"/>
  -->


  <!-- HappyTrails 2.0 Task Definition (tasks with ht2: prefix) -->
  <taskdef resource="amazon/ht2/trails/ant/antlib.xml" onerror="fail"
    uri="antlib:amazon.ht2.trails.ant" classpath="${amazon.ht2.boot.path}" />


  <target name="init:properties" description="Initializes HappyTrails Project Configuration" unless="init:properties.alreadyrun">
    <!--
       For more information about what this task does, see:

       https://spectre.amazon.com/?HappyTrails2/AntTaskGuide/HT2Configure
    -->
    <ht2:configure />

    <property name="init:properties.alreadyrun" value="true"/>
  </target>


  <target name="init:directories" depends="init:properties"
    description="Creates build directory structure">

    <!--
       For more information about how these properties get set up, see:

       https://spectre.amazon.com/?HappyTrails2/BuildPropertiesGuide
    -->
    <mkdir dir="${amazon.ht2.bd.workspace.build.dir}" />
    <mkdir dir="${amazon.ht2.bd.thisPackage.build.dir}" />
    <mkdir dir="${amazon.ht2.bd.generated-ant.output.dir}" />
    <mkdir dir="${amazon.ht2.bd.private.output.dir}" />
    <mkdir dir="${amazon.ht2.bd.bin.output.dir}" />
    <mkdir dir="${amazon.ht2.bd.lib.output.dir}" />

    <!--
      NOTE! interface.dep is required for PackageBuilder builds:
      please see http://devcentral.amazon.com/help/faq.cgi?cid=2#311
    -->
    <mkdir dir="${amazon.ht2.bd.interface.dep.output.dir}" />
    <touch file="${amazon.ht2.bd.interface.dep.output.dir}/interface.dep" />
  </target>

  <!-- the symlink task has a bug (feature?) where it is not rerunnable...
       after being executed once, it resets its values to null and ant doesn't
       reset them before executing it again.  this is a problem when multiple
       targets are specified on the command-line. -->
  <target name="symlink.guard" depends="init:properties">
    <condition property="symlink.skip">
      <or>
        <isset property="amazon.ht2.os.isWindows"/>
        <isset property="symlink.alreadyrun"/>
      </or>
    </condition>
  </target>

  <target name="symlink" depends="init:directories, symlink.guard" unless="symlink.skip"
    description="Creates a convenient 'build' symlink when _not_ building on Windows">
    <symlink action="single" overwrite="true" link="build" resource="${amazon.ht2.bd.thisPackage.build.dir}"/>
    <property name="symlink.alreadyrun" value="true"/>
  </target>


  <target name="clean" depends="init:properties"
    description="removes package build directory">
    <delete dir="${amazon.ht2.bd.thisPackage.build.dir}"/>
  </target>


  <target name="commonTrails" depends="symlink" unless="commonTrails.alreadyrun"
    description="caches packages and initializes classpaths">
    <!--
       For more information about what this task does, see:

       https://spectre.amazon.com/?HappyTrails2/AntTaskGuide/HT2Resolve
    -->
    <ht2:resolve />


    <!--
       For more information about what this task does, see:

       https://spectre.amazon.com/?HappyTrails2/AntTaskGuide/HT2Properties
    -->
    <ht2:properties />


    <!--
       For more information about what these tasks do, see:

       https://spectre.amazon.com/?HappyTrails2/AntTaskGuide/HT2Path
    -->
    <ht2:path dependencyType="run"   artifactType="jar"  property="run.classpath"   />
    <ht2:path dependencyType="build" artifactType="jar"  property="build.classpath" />
    <ht2:path dependencyType="test"  artifactType="jar"  property="test.classpath"  />

    <!-- guard against multiple invocations of commonTrails, since they will fail -->
    <property name="commonTrails.alreadyrun" value="true"/>
  </target>

 
</project>
